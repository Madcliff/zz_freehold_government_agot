zz_become_landed_transfer_no_ennobled_modifier_effect = {
	destroy_laamp_effect = { ADVENTURER = $TITLE_RECEIVER$ }
	$TITLE_RECEIVER$ = {
		set_variable = {
			name = ascended_throne_reason
			value = $REASON$
			weeks = 1
		}
	}
	create_title_and_vassal_change = {
		type = $TYPE$
		add_claim_on_loss = yes
		save_scope_as = title_change
	}
	ordered_in_list = {
		list = $TITLE_LIST$
		limit = {
			is_landless_type_title = no
			is_noble_family_title = no
		}
		order_by = tier
		save_scope_as = new_primary_title
	}
	every_in_list = {
		list = $TITLE_LIST$
		limit = {
			is_leased_out = no
			is_landless_type_title = no
			is_head_of_faith = no
		}
		change_title_holder_include_vassals = {
			holder = $TITLE_RECEIVER$
			change = scope:title_change
			take_baronies = yes
		}
	}
	ordered_in_list = {
		list = $TITLE_LIST$
		order_by = tier
		save_scope_as = new_primary_title
	}
	resolve_title_and_vassal_change = scope:title_change
	
	$TITLE_RECEIVER$ = {
		change_government = feudal_government 
	}
}

zz_adopt_to_house_effect = {
	$ADOPTER$ = {
		$CHILD$ = {
			hidden_effect = {
				set_house = $ADOPTER$.house
				found_cadet_house_decision_effect = {
					CHARACTER = scope:recipient
					PRESTIGE = 0
				}
			}
			custom_tooltip = adventurer_adoption_child_tt
			# Remove bastard traits
			if = {
				limit = {
					has_any_bastard_trait_trigger = yes
				}
				remove_all_bastard_traits = yes
			}
			# Remove disinherited if you're the house head.
			if = {
				limit = {
					$ADOPTER$.house.house_head = $ADOPTER$
					has_trait = disinherited
				}
				remove_trait = disinherited
			}
		}
	}
	#adopted child should travel to new parent
	$CHILD$ = {
		if = {
			limit = { exists = $ADOPTER$.capital_province } # Ward heads to landed Guardian
			$ADOPTER$.capital_province = { save_scope_as = destination_province }
		}
		else_if = { # Ward heads to Guardian's host
			limit = { exists = $ADOPTER$.host.capital_province }
			$ADOPTER$.host.capital_province = { save_scope_as = destination_province }
		}
		else = {
			$ADOPTER$.location = { save_scope_as = destination_province }
		}
		save_scope_as = adoptee
		$ADOPTER$ = {
			save_scope_as = adopter
		}
		if = {
			limit = {
				any_relation = {
					type = guardian
					NOT = { this = $ADOPTER$ }
				}
			}
			random_relation = {
				type = guardian
				limit = { NOT = { this = $ADOPTER$ } }
				save_scope_as = old_guardian
			}
			remove_guardian_effect = {
				GUARDIAN = scope:old_guardian
				WARD = scope:adoptee
				RETURN_WARD = no
				HIDE_OPINION = no
			}
		}
		if = {
			limit = { NOT = { scope:destination_province = $CHILD$.location } }
			set_variable = {
				name = adoptee_travelling_to_adopter
				years = 2
				value = scope:adopter
			}
			start_travel_plan = {
				destination = scope:destination_province
				on_start_on_action = on_adoptee_depart_for_adopter
				on_travel_planner_cancel_on_action = on_adoptee_depart_travel_planner_exit
				on_arrival_on_action = on_adoptee_arrive_at_adopter
				on_arrival_destinations = last
				return_trip = no # One way
			}
			custom_tooltip = adoptee_leaves_for_adopter_tt
		}
	}
}

create_noble_family_dragonrider_effect = {
	debug_log = create_noble_family_title

	save_scope_as = new_noble_family_holder
	hidden_effect = { # NF can only be held by house heads
		house ?= {
			if = {
				limit = { house_head != scope:new_noble_family_holder }
				set_house_head = scope:new_noble_family_holder
			}
		}
	}
	add_character_flag = new_government_is_freehold_admin
	tgp_domicile_conversion_when_changing_government_type = {
			NEW_DOMICILE_TYPE = dragonkeep
			NEW_GOVERNMENT_TYPE = freehold_government
		}
	change_government = freehold_government 
	remove_character_flag = new_government_is_freehold_admin

	custom_description = {
		text = create_noble_family_tt
	}

	#Notifications
	top_liege ?= {
		every_vassal = {
			limit = {
				is_ai = no
				NOT = { this = scope:new_noble_family_holder }
			}
			trigger_event = {
				id = ep3_emperor_yearly.2410
				days = 1
			}
		}
	}

	debug_log_scopes = yes
}





convert_to_administrative_from_feudalism_effect = {
	save_scope_as = administrative_liege
	
	switch = {
		trigger = $GOVERNMENT_TO_ADOPT$
		flag:dynamic = { # If we want the selection to be dynamic, save and clear the scope to prevent errors
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:dynamic
			}
			clear_saved_scope = has_selected_a_government
		}
		flag:freehold = { # freehold_government / Administrative
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:freehold
			}
		}
		flag:administrative = { # administrative_government / Administrative
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:administrative
			}
		}
		flag:celestial = { # celestial_government / Celestial
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:celestial
			}
		}
		flag:meritocratic = { # meritocratic_government / Meritocratic
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:meritocratic
			}
		}
		flag:japan_administrative = { # japan_administrative_government / Ritsuryo
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:japan_administrative
			}
		}
	}

	change_to_administrative_effect = yes

	#Direct Vassals who fulfill the ep3_vassal_will_become_admin criteria are converted. Vassals above 25 opinion always accept
	#Vassals are converted as a hierarchy. If a king is converted we convert all who are valid below that king (so his dukes, their counts, and their barons) are all converted.
	#If a vassal does not convert (because of not accepting or because they are outside of the de jure empire, etc) then the vassals below them are _not_ converted either.

	#Human vassals are given a choice to convert or not in the ping event, even if powerful or having very good relation.

	hidden_effect = { 
		save_scope_as = actor
		every_powerful_vassal = { #All valid powerful vassals auto convert - their support was required to take the decision.
			limit = {
				ep3_vassal_will_become_admin = yes
				is_ai = yes
			}
			save_scope_as = recipient
			change_to_administrative_effect = yes	
			every_vassal = { #Everyone below also converts
				limit = {
					ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
					is_ai = yes
				}
				save_scope_as = recipient	
				change_to_administrative_effect = yes
				every_vassal = { #Everyone below also converts (could be Counts, could be Barons)
					limit = {
						ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
						is_ai = yes
					}
					save_scope_as = recipient	
					change_to_administrative_effect = yes
					every_vassal = { #Everyone below also converts could be Barons)
						limit = {
							ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
							is_ai = yes
						}
						save_scope_as = recipient
						change_to_administrative_effect = yes
					}
				}
			}
		}
		every_vassal = {
			limit = {
				ep3_vassal_will_become_admin = yes
				trigger_if = { #Dukes and above can say no
					limit = {
						primary_title.tier >= tier_duchy
						is_ai = yes
					}
					opinion = {
						target = scope:administrative_liege
						value > 25
					}
				}
			}
			save_scope_as = recipient
			change_to_administrative_effect = yes
			every_vassal = { #Everyone below also converts (could be Counts, could be Dukes)
				limit = {
					ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
					is_ai = yes
				}
				save_scope_as = recipient	
				change_to_administrative_effect = yes
				every_vassal = { #Everyone below also converts (Could be Counts, could be Barons)
					limit = {
						ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
						is_ai = yes
					}
					save_scope_as = recipient	
					change_to_administrative_effect = yes
					every_vassal = { #Everyone below also converts (could be Barons)
						limit = {
							ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
							is_ai = yes
						}
						save_scope_as = recipient
						change_to_administrative_effect = yes
					}
				}
			}
		}
		every_vassal = {
			limit = {
				ep3_vassal_will_become_admin = yes
				trigger_if = { #Dukes and above can say no
					limit = {
						primary_title.tier >= tier_duchy
						is_ai = yes
					}
					opinion = {
						target = scope:administrative_liege
						value > 0
					}
				}
			}
			random_list = {
				10 = { } #10% of the vassals that like us less than 25 but more than 0 still convert.
				90 = {
					save_scope_as = recipient
					change_to_administrative_effect = yes
					every_vassal = { #Everyone below also converts (could be Counts, could be Dukes)
						limit = {
							ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
							is_ai = yes
						}
						save_scope_as = recipient	
						change_to_administrative_effect = yes
						every_vassal = { #Everyone below also converts (Could be Counts, could be Barons)
							limit = {
								ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
								is_ai = yes
							}
							save_scope_as = recipient	
							change_to_administrative_effect = yes
							every_vassal = { #Everyone below also converts (could be Barons)
								limit = {
									ep3_vassal_will_become_admin = yes #We still don't want mayors and bishops
									is_ai = yes
								}
								save_scope_as = recipient	
								change_to_administrative_effect = yes
							}
						}
					}
				}
			}
		}
		every_vassal = {
			limit = {
				highest_held_title_tier >= tier_duchy
				house.house_head ?= this
				government_has_flag = government_is_administrative
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
			create_noble_family_effect = { GOVERNMENT_GIVER = this }
		}
	}

	if = {
		limit = {
			#AGOT Disabled
			# NOT = {
			# 	has_character_flag = latin_emp_force_admin_flag
			# }
			top_liege = this
		}
		add_character_modifier = {
			modifier = first_admin_emperor
		}
	}
	
	change_influence = admin_convert_influence_value

	custom_description_no_bullet = {
		text = vassals_can_become_administrative
	}
	custom_tooltip = powerful_vassals_become_administrative
	custom_tooltip = vassals_become_administrative
	custom_tooltip = vassals_who_may_switch_to_administrative
}

change_to_administrative_interaction_effect = {
	scope:actor = {
		if = {
			limit = { has_treasury = yes }
			pay_short_term_treasury = {
				target = scope:recipient
				treasury = {
					value = 50
					scope:recipient = {
						if = {
							limit = { highest_held_title_tier >= tier_kingdom }
							multiply = 10
						}
						else_if = {
							limit = { highest_held_title_tier >= tier_duchy }
							multiply = 6
						}
						else_if = {
							limit = { highest_held_title_tier >= tier_county }
							multiply = 3
						}
					}
					if = {
						limit = { scope:gold ?= yes }
						add = scope:actor.medium_gold_value
					}
					if = {
						limit = {
							scope:actor = { has_realm_law_flag = admin_change_vassal_gov_cheaper }
						}
						multiply = 0.5
					}
				}
			}
		}
		else = {
			pay_short_term_gold = {
				target = scope:recipient
				gold = {
					value = 50
					scope:recipient = {
						if = {
							limit = { highest_held_title_tier >= tier_kingdom }
							multiply = 10
						}
						else_if = {
							limit = { highest_held_title_tier >= tier_duchy }
							multiply = 6
						}
						else_if = {
							limit = { highest_held_title_tier >= tier_county }
							multiply = 3
						}
					}
					if = {
						limit = { scope:gold ?= yes }
						add = scope:actor.medium_gold_value
					}
					if = {
						limit = {
							scope:actor = { has_realm_law_flag = admin_change_vassal_gov_cheaper }
						}
						multiply = 0.5
					}
				}
			}
		}
	}
	scope:recipient = {
		change_to_administrative_effect = yes

		#And now we also convert all the administrative vassals below so they also match the actor's form of admin.
		#For non admin sub-vassals the newly converted main vassal can still ask using the same interaction but we 
		hidden_effect = {
			every_vassal_or_below = {
				limit = {
					government_allows = administrative
					is_ai = yes #Humans get to be asked directly
				}
				change_to_administrative_effect = yes
			}
		}
	}
	if = {
		limit = {
			scope:hook = yes
			scope:actor = { has_usable_hook = scope:recipient }
		}
		scope:actor = { use_hook = scope:recipient }
	}
	if = {
		limit = { scope:hereditary = yes }
		scope:recipient = { save_scope_as = petition_vassal }
		change_to_administrative_hereditary_effect = yes
	}
	if = {
		limit = { scope:influence = yes }
		scope:actor = {
			change_influence = {
				value = massive_influence_loss
			}
		}
	}
}

change_to_administrative_effect = {
	save_scope_as = governor
	top_liege = { save_scope_as = governor_liege }
	# Set the correct government
	if = {
		limit = {
			OR = {
				NOT = { government_allows = administrative }
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_freehold}
					NOT = { government_has_flag = government_is_freehold }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_japan_administrative }
					NOT = { government_has_flag = government_is_japan_administrative }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_meritocratic }
					NOT = { government_has_flag = government_is_meritocratic }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_celestial }
					NOT = { government_has_flag = government_is_celestial }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_steppe_admin }
					NOT = { government_has_flag = government_is_steppe_admin }
				}
			}
		}
		# Only case where Estate type is shared between Admin and non-Admin
		if = {
			limit = {
				NAND = {
					government_has_flag = government_is_japan_feudal
					scope:governor_liege = { government_has_flag = government_is_japan_administrative }
				}
			}
			save_scope_as = new_admin
		}
		if = {
			limit = {
				NOT = { exists = scope:has_selected_a_government }
				OR = {
					top_liege = {
						has_character_flag = zz_valyria_freehold
					}
					has_character_flag = zz_valyria_freehold
				}
				
			}
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:freehold
			}
		}
		# If we are greek, let's ensure we become administrative
		if = {
			limit = {
				NOT = { exists = scope:has_selected_a_government }
				top_liege = {
					OR = {
						culture = culture:greek
						culture = {
							any_parent_culture_or_above = { this = culture:greek }
						}
					}
				}
			}
			save_scope_value_as = {
				name = has_selected_a_government
				value = flag:administrative
			}
		}

		# Change government
		# We first check if you have a selected government, then if you are independent, then what your liege has
		if = { # Ritsuryo
			limit = {
				trigger_if = {
					limit = {
						exists = scope:has_selected_a_government
					}
					scope:has_selected_a_government = flag:japan_administrative
				}
				trigger_else_if = {
					limit = {
						top_liege = this
					}
					has_tgp_dlc_trigger = yes
					tgp_can_become_japan_administrative_trigger = yes
				}
				trigger_else = {
					scope:governor_liege = { government_has_flag = government_is_japan_administrative }
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = japanese_manor
				NEW_GOVERNMENT_TYPE = japan_administrative_government
			}
			change_government = japan_administrative_government
		}
		else_if = { # Celestial
			limit = {
				trigger_if = {
					limit = {
						exists = scope:has_selected_a_government
					}
					scope:has_selected_a_government = flag:celestial
				}
				trigger_else_if = {
					limit = {
						top_liege = this
					}
					has_tgp_dlc_trigger = yes
					OR = {
						tgp_can_become_celestial_trigger = yes
						#This is Mongol breakup and they are hegemon
						#AGOT Disabled
						# AND = {
						# 	exists = scope:great_yuan_ruler
						# 	this = scope:great_yuan_ruler
						# 	primary_title = title:h_china
						# }
					}
				}
				trigger_else = {
					scope:governor_liege = { government_has_flag = government_is_celestial }
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = celestial_government
			}
			change_government = celestial_government
		}
		else_if = { # Meritocratic Khanate
			limit = {
				trigger_if = {
					limit = {
						exists = scope:has_selected_a_government
					}
					# There's a separate decision to go from Nomad to Meritocratic Khanate, so you cannot pick it from here
					always = no
				}
				trigger_else = {
					scope:governor_liege = { government_has_flag = government_is_steppe_admin }
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = steppe_admin_government
			}
			change_government = steppe_admin_government
		}
		else_if = { # Meritocratic
			limit = {
				trigger_if = {
					limit = {
						exists = scope:has_selected_a_government
					}
					scope:has_selected_a_government = flag:meritocratic
				}
				trigger_else_if = {
					limit = {
						top_liege = this
					}
					has_tgp_dlc_trigger = yes
					tgp_should_become_meritocratic_trigger = yes
				}
				trigger_else = {
					scope:governor_liege = { government_has_flag = government_is_meritocratic }
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = meritocratic_government
			}
			change_government = meritocratic_government
		}
		else_if = {
			limit = {
				trigger_if = {
					limit = {
						exists = scope:has_selected_a_government
					}
					scope:has_selected_a_government = flag:freehold
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = city_holding
				}
			}
			add_character_flag = new_government_is_freehold_admin
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = dragonkeep
				NEW_GOVERNMENT_TYPE = freehold_government
			}
			change_government = freehold_government 
			remove_character_flag = new_government_is_freehold_admin
		}
		else = { # Administrative
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			add_character_flag = new_government_is_byz_admin
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = estate
				NEW_GOVERNMENT_TYPE = administrative_government
			}
			change_government = administrative_government 
			remove_character_flag = new_government_is_byz_admin
		}
	}
	# Set up a noble family title
	if = {
		limit = {
			primary_title.tier >= min_appointment_tier
			liege = {
				scope:governor_liege = this
				government_allows = administrative
			}
			house.house_head = {
				top_liege = scope:governor_liege
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
		}
		create_noble_family_effect = { GOVERNMENT_GIVER = top_liege }
	}
	# Add the governor trait if applicable
	hidden_effect = {
		if = {
			limit = {
				is_governor = yes
				NOT = { has_trait = governor }
			}
			add_trait = governor
		}
	}
	# Set up the domicile
	if = {
		limit = {
			exists = scope:new_admin
			exists = domicile
		}
		domicile ?= {
			set_up_domicile_estate_effect = yes
		}
	}
	if = {
		limit = {
			has_treasury = yes
		}
		add_treasury = {
			value = gold
			min = 100
		}
	}
}







tgp_domicile_conversion_when_changing_government_type = {
	hidden_effect = {
		if = {
			limit = {
				any_held_title = {
					is_noble_family_title = yes
				}
				has_domicile = yes
				NOT = {
					domicile ?= {
						is_domicile_type = $NEW_DOMICILE_TYPE$
					}
				}
			}
			random_held_title = {
				limit = {
					is_noble_family_title = yes
				}
				save_scope_as = old_nf_title
			}
			tgp_wipe_domicile_effect = yes

			
			if = {
				limit = {
					has_character_flag = new_government_is_byz_admin
				}
				give_noble_family_title = {
					name = noble_family_name
					tier = duchy
					article = DEFAULT_TITLE_NAME_ARTICLE
					government = $NEW_GOVERNMENT_TYPE$
					save_scope_as = new_title
				}
			}
			else_if = {
				limit = {
					has_character_flag = new_government_is_freehold_admin
				}
				give_noble_family_title = {
					name = noble_family_name
					tier = county
					article = DEFAULT_TITLE_NAME_ARTICLE
					government = $NEW_GOVERNMENT_TYPE$
					save_scope_as = new_title
				}
			}
			else = {
				give_noble_family_title = {
					name = noble_family_name
					tier = county
					article = DEFAULT_TITLE_NAME_ARTICLE
					government = $NEW_GOVERNMENT_TYPE$
					save_scope_as = new_title
				}
			}
			scope:new_title = {
				copy_title_history = scope:old_nf_title
			}
			destroy_title = scope:old_nf_title
			domicile ?= {
				set_up_domicile_estate_effect = yes
			}
		}
	}
}

create_noble_family_effect = {
	debug_log = create_noble_family_title
	save_scope_as = new_noble_family_holder
	$GOVERNMENT_GIVER$ = { save_scope_as = government_giver }
	hidden_effect = { # NF can only be held by house heads
		if = { # Start by checking that we are not the house head already
			limit = {
				house ?= { house_head != scope:new_noble_family_holder }
			}
			if = { # If not, let's see if it would be reasonable to become house head...
				limit = {
					house.house_head ?= {
						top_liege = scope:new_noble_family_holder.top_liege
						OR = {
							is_ruler = no
							primary_title.tier <= tier_county
						}
						is_ai = yes #  Don't steal house head from a player
					}
				}
				house = { set_house_head = scope:new_noble_family_holder }
			}
			else = { # ... Otherwise, we create a cadet branch
				create_cadet_branch = {}
			}
		}
	}
	scope:government_giver = {
		if = {
			limit = {
				scope:new_noble_family_holder = {
					NOT = {
						any_held_title = { is_noble_family_title = yes }
					}
				}
			}
			switch = {
				trigger = has_government
				japan_administrative_government = { # Japan has count level NFs
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = japan_administrative_government
							save_scope_as = new_title
						}
					}
				}
				japan_feudal_government = { # Japan has count level NFs
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = japan_feudal_government
							save_scope_as = new_title
						}
					}
				}
				celestial_government = { # China has different government
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = celestial_government
							save_scope_as = new_title
						}
						trigger_event = {
							id = tgp_china_career.0001
							days = { 2 5 }
						}
					}
				}
				meritocratic_government = { # Meritocratic has different government
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = meritocratic_government
							save_scope_as = new_title
						}
					}
				}
				steppe_admin_government = { # Steppe Admin has different government
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = steppe_admin_government
							save_scope_as = new_title
						}
					}
				}
				freehold_government = { # Steppe Admin has different government
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = county
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = freehold_government
							save_scope_as = new_title
						}
					}
				}
				fallback = {
					scope:new_noble_family_holder = {
						give_noble_family_title = {
							name = noble_family_name
							tier = duchy
							article = DEFAULT_TITLE_NAME_ARTICLE
							government = administrative_government
							save_scope_as = new_title
						}
					}
				}
			}
		}
		scope:new_title.holder ?= {
			save_scope_as = noble_family_head
			scope:new_title = { set_coa = scope:noble_family_head.house }
		}
		custom_description = { text = create_noble_family_tt }

		#Notifications
		every_player = {
			limit = {
				top_liege = scope:new_noble_family_holder.top_liege
				this != scope:new_noble_family_holder
				# China has hundreds of Noble Families, it gets spammy
				NOT = { government_allows = merit }
			}
			trigger_event = {
				id = ep3_emperor_yearly.2410
				days = 1
			}
		}
	}

	debug_log_scopes = yes
}




set_up_domicile_estate_effect = {
	if = {
		limit = { is_domicile_type = estate }
		# Intentionally one level lower than what you can get
		if = {
			limit = {
				NOT = { has_domicile_building_or_higher = estate_main_02 }
				owner.culture ?= { has_innovation = innovation_city_planning }
			}
			add_domicile_building = estate_main_02
		}
		if = {
			limit = {
				has_domicile_building = estate_main_02
				NOT = { has_domicile_building_or_higher = estate_main_03 }
				owner.culture ?= { has_innovation = innovation_manorialism }
			}
			add_domicile_building = estate_main_03
		}
		hidden_effect = {
			switch = {
				trigger = has_domicile_building
				estate_main_03 = {
					while = {
						count = 2
						add_random_internal_estate_building = yes
					}
				}
				estate_main_02 = {
					add_random_internal_estate_building = yes
				}
			}
		}
		fill_external_estate_building_effect = yes
	}
	else_if = {
		limit = { is_domicile_type = estate }
		# Intentionally one level lower than what you can get
		if = {
			limit = {
				NOT = { has_domicile_building_or_higher = dragonkeep_main_02 }
				owner.culture ?= { has_innovation = innovation_city_planning }
			}
			add_domicile_building = dragonkeep_main_02
		}
		if = {
			limit = {
				has_domicile_building = dragonkeep_main_02
				NOT = { has_domicile_building_or_higher = dragonkeep_main_03 }
				owner.culture ?= { has_innovation = innovation_manorialism }
			}
			add_domicile_building = dragonkeep_main_03
		}
		hidden_effect = {
			switch = {
				trigger = has_domicile_building
				dragonkeep_main_03 = {
					while = {
						count = 2
						add_random_internal_dragonkeep_building = yes
					}
				}
				dragonkeep_main_02 = {
					add_random_internal_dragonkeep_building = yes
				}
			}
		}
		fill_external_dragonkeep_building_effect = yes
	}
	else_if = {
		limit = { is_domicile_type = japanese_manor }
		# Intentionally one level lower than what you can get
		if = {
			limit = {
				NOT = { has_domicile_building_or_higher = japanese_manor_main_02 }
				owner.culture ?= { has_innovation = innovation_city_planning }
			}
			add_domicile_building = japanese_manor_main_02
		}
		if = {
			limit = {
				has_domicile_building = japanese_manor_main_02
				NOT = { has_domicile_building_or_higher = japanese_manor_main_03 }
				owner.culture ?= { has_innovation = innovation_manorialism }
			}
			add_domicile_building = japanese_manor_main_03
		}
		hidden_effect = {
			switch = {
				trigger = has_domicile_building
				japanese_manor_main_03 = {
					while = {
						count = 2
						add_random_internal_japanese_manor_building = yes
					}
				}
				japanese_manor_main_02 = {
					add_random_internal_japanese_manor_building = yes
				}
			}
		}
		fill_external_japanese_manor_building_effect = yes
	}
	else_if = {
		limit = { is_domicile_type = east_asian_estate }
		# Intentionally one level lower than what you can get
		if = {
			limit = {
				NOT = { has_domicile_building_or_higher = east_asian_estate_main_02 }
				owner.culture ?= { has_innovation = innovation_city_planning }
			}
			add_domicile_building = east_asian_estate_main_02
		}
		if = {
			limit = {
				has_domicile_building = east_asian_estate_main_02
				NOT = { has_domicile_building_or_higher = east_asian_estate_main_03 }
				owner.culture ?= { has_innovation = innovation_manorialism }
			}
			add_domicile_building = east_asian_estate_main_03
		}
		hidden_effect = {
			switch = {
				trigger = has_domicile_building
				east_asian_estate_main_03 = {
					while = {
						count = 2
						add_random_internal_east_asian_estate_building = yes
					}
				}
				east_asian_estate_main_02 = {
					add_random_internal_east_asian_estate_building = yes
				}
			}
		}
		fill_external_east_asian_estate_building_effect = yes
	}
}


add_random_internal_dragonkeep_building = {
	random_list = {
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = servants_quarters_01 }
			}
			add_domicile_building = servants_quarters_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = servants_quarters_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = library_01 }
			}
			add_domicile_building = library_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = library_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = bath_01 }
			}
			add_domicile_building = bath_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = bath_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = courtyard_01 }
			}
			add_domicile_building = courtyard_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = courtyard_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = prison_01 }
			}
			add_domicile_building = prison_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = prison_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = living_quarters_01 }
			}
			add_domicile_building = living_quarters_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = living_quarters_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = trophy_room_01 }
			}
			add_domicile_building = trophy_room_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = trophy_room_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = office_01 }
			}
			add_domicile_building = office_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = office_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = guest_room_01 }
			}
			add_domicile_building = guest_room_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = guest_room_02
			}
		}
		10 = {
			trigger = {
				NOT = { has_domicile_building_or_higher = wine_cellar_01 }
			}
			add_domicile_building = wine_cellar_01
			if = {
				limit = { has_domicile_building = dragonkeep_main_03 }
				add_domicile_building = wine_cellar_02
			}
		}
	}
}

fill_external_dragonkeep_building_effect = {
	switch = {
		trigger = has_domicile_building_or_higher
		estate_main_05 = {
			while = {
				limit = { free_external_domicile_building_slots >= 1 }
				add_random_external_dragonkeep_building = yes
			}
		}
		estate_main_04 = {
			while = {
				limit = { free_external_domicile_building_slots >= 2 }
				add_random_external_dragonkeep_building = yes
			}
		}
		estate_main_03 = {
			while = {
				limit = { free_external_domicile_building_slots >= 3 }
				add_random_external_dragonkeep_building = yes
			}
		}
		estate_main_02 = {
			while = {
				limit = { free_external_domicile_building_slots >= 4 }
				add_random_external_dragonkeep_building = yes
			}
		}
		estate_main_01 = {
			while = {
				limit = { free_external_domicile_building_slots >= 5 }
				add_random_external_dragonkeep_building = yes
			}
		}
	}
}

add_random_external_dragonkeep_building = {
	if = {
		limit = {
			free_external_domicile_building_slots >= 1
		}
		random_list = {
			10 = {
				trigger = {
					NOR = { 
						has_domicile_building_or_higher = temple_small_01
						owner = {
							government_has_flag = government_is_celestial 
						}
					}
				}
				add_domicile_building = temple_small_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = temple_small_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = barracks_01 }
				}
				add_domicile_building = barracks_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = barracks_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = watchtower_01 }
				}
				add_domicile_building = watchtower_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = watchtower_02
				}
			}
			10 = {
				trigger = {
					NOR = { 
						has_domicile_building_or_higher = vineyard_01 
						owner.culture ?= {
							has_innovation = innovation_champa_rice
						}
					}
				}
				add_domicile_building = vineyard_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = vineyard_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = guardhouse_01 }
				}
				add_domicile_building = guardhouse_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = guardhouse_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = garden_01 }
				}
				add_domicile_building = garden_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = garden_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = storage_01 }
				}
				add_domicile_building = storage_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = storage_02
				}
			}
			10 = {
				trigger = {
					NOR = { 
						has_domicile_building_or_higher = grain_field_01
						owner.culture ?= {
							has_innovation = innovation_champa_rice
						}
					}
				}
				add_domicile_building = grain_field_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = grain_field_02
				}
			}
			10 = {
				trigger = {
					NOT = { 
						has_domicile_building_or_higher = rice_field_01
					}
					owner.culture ?= {
						has_innovation = innovation_champa_rice
					}
				}
				add_domicile_building = rice_field_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = rice_field_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = stable_01 }
				}
				add_domicile_building = stable_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = stable_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = workshop_01 }
				}
				add_domicile_building = workshop_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = workshop_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = market_01 }
				}
				add_domicile_building = market_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = market_02
				}
			}
			10 = {
				trigger = {
					NOT = { has_domicile_building_or_higher = grazing_land_01 }
				}
				add_domicile_building = grazing_land_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = grazing_land_02
				}
			}
			10 = {
				trigger = {
					NOR = { 
						has_domicile_building_or_higher = olive_01 
						owner.culture ?= {
							has_innovation = innovation_champa_rice
						}
					}
				}
				add_domicile_building = olive_01
				if = {
					limit = { has_domicile_building = dragonkeep_main_03 }
					add_domicile_building = olive_02
				}
			}
		}
	}
}